# 自动化部署流程规范

本文档定义了如何通过配置驱动的方式实现项目的快速部署。核心逻辑是：**用户提供配置 -> AI 自动修改项目 -> 生成发布脚本 -> 用户确认 -> 脚本执行发布**。

## 一、 部署前置配置

在开始部署前，用户需要提供基础部署信息。这些配置已统一在 [规范-00-全局定义.md](./规范-00-全局定义.md) 的 **全局定义** 中维护。

AI 将读取 these 全局变量，用于自动修改项目的 `application-prod.yml`、`Nginx` 配置以及 `scripts` 脚本。

---

## 二、 自动化部署流程

1.  **配置注入**:
    *   AI 读取上述配置，更新后端 `src/main/resources/application-prod.yml`。
    *   AI 更新前端 `.env.production` 中的 `VITE_API_BASE_URL`。
2.  **脚本生成**:
    *   AI 根据部署路径和服务器信息，在 `scripts/` 目录下生成或更新 `deploy-backend.sh` and `deploy-frontend.sh`。
3.  **构建产物**:
    *   执行本地构建（Maven 打包后端，npm 构建前端）。
4.  **执行发布**:
    *   运行发布脚本。**脚本最后一步必须包含交互式确认**。
    *   确认通过后，脚本自动通过 `scp/rsync` 将产物推送到服务器并执行重启指令。

## 三、 标准发布脚本模板

### 1. 后端发布脚本 (`scripts/deploy-backend.sh`)
```bash
#!/bin/bash
# 1. 环境准备
# 获取脚本所在目录的上一级，即项目根目录
BASE_DIR=$(cd $(dirname $0)/..; pwd)

# 2. 变量定义
APP_NAME="{{PROJECT_NAME}}-backend"
SERVER_IP="{{SERVER_IP}}"
DEPLOY_DIR="{{DEPLOY_ROOT}}/backend"
# 产物路径指向后端源码目录下的 target
JAR_FILE="${BASE_DIR}/{{BACKEND_CODE_DIR}}/target/{{SERVICE_NAME}}.jar"

# 3. 构建产物检查
if [ ! -f "$JAR_FILE" ]; then
    echo "错误：未找到构建产物 $JAR_FILE"
    echo "请检查是否在 ${BASE_DIR}/{{BACKEND_CODE_DIR}} 目录下成功执行了 mvn clean package"
    exit 1
fi

# 4. 用户确认 (关键步骤)
echo "------------------------------------------------"
echo "准备发布后端应用到: $SERVER_IP:$DEPLOY_DIR"
echo "产物路径: $JAR_FILE"
echo "版本信息: $(date +%Y%m%d%H%M%S)"
echo "------------------------------------------------"
read -p "确认执行发布吗？(y/n): " confirm

if [ "$confirm" != "y" ]; then
    echo "发布已取消。"
    exit 0
fi

# 5. 执行上传与重启
echo "正在上传产物..."
scp -P {{SSH_PORT}} $JAR_FILE {{SSH_USER}}@$SERVER_IP:$DEPLOY_DIR/
ssh -p {{SSH_PORT}} {{SSH_USER}}@$SERVER_IP "cd $DEPLOY_DIR && ./restart.sh"
echo "后端发布完成！"
```

### 2. 前端发布脚本 (`scripts/deploy-frontend.sh`)
```bash
#!/bin/bash
# 1. 环境准备
BASE_DIR=$(cd $(dirname $0)/..; pwd)

# 2. 变量定义
SERVER_IP="{{SERVER_IP}}"
WEB_ROOT="{{DEPLOY_ROOT}}/frontend"
# 产物路径指向前端源码目录下的 dist
DIST_DIR="${BASE_DIR}/{{FRONTEND_CODE_DIR}}/dist/"

# 3. 构建产物检查
if [ ! -d "$DIST_DIR" ]; then
    echo "错误：未找到构建目录 $DIST_DIR"
    echo "请检查是否在 ${BASE_DIR}/{{FRONTEND_CODE_DIR}} 目录下成功执行了 npm run build"
    exit 1
fi

# 4. 用户确认 (关键步骤)
echo "------------------------------------------------"
echo "准备发布前端资源到: $SERVER_IP:$WEB_ROOT"
echo "产物路径: $DIST_DIR"
echo "------------------------------------------------"
read -p "确认执行发布吗？(y/n): " confirm

if [ "$confirm" != "y" ]; then
    echo "发布已取消。"
    exit 0
fi

# 5. 执行上传
echo "正在同步前端资源..."
rsync -avz -e "ssh -p {{SSH_PORT}}" --delete $DIST_DIR {{SSH_USER}}@$SERVER_IP:$WEB_ROOT/
echo "前端发布完成！"
```

## 四、 约束要求

*   **交互确认**: 所有发布脚本在执行真正的上传和重启操作前，必须有 `read -p` 提示用户确认。
*   **配置隔离**: 生产环境配置（如数据库密码）严禁硬编码在 `application.yml` 中，应由 AI 根据部署前置配置动态填充。
*   **脚本权限**: 生成的脚本需具备执行权限 (`chmod +x scripts/*.sh`)。
