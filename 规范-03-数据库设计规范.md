# 数据库设计规范

- 适用范围：MySQL 5.7+（InnoDB），用于指导 AI 直接生成可落库的建表 SQL（含字段注释、索引）。
- 关联文档：
  - [规范-00-全局定义.md](规范-00-全局定义.md)（表前缀：`{{TABLE_PREFIX}}`）

## 一、强制全局约束（AI 必须遵守）

- **表名前缀**：所有业务表名必须以 `{{TABLE_PREFIX}}` 开头（来自 [规范-00-全局定义.md](规范-00-全局定义.md)），禁止使用固定 `t_`、`tbl_` 等其他前缀。
- **存储引擎**：必须 `ENGINE=InnoDB`。
- **字符集与排序规则**：必须 `DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci`。
- **时间类型**：必须使用 `DATETIME`，并使用默认值与自动更新时间：
  - `create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP`
  - `last_modified_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP`
- **软删除**：必须使用 `is_deleted TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0未删；1已删'`，严禁物理删除（除归档/清理任务外）。
- **状态字段**：必须使用 `status TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1正常；0禁用'`（如业务需要更多状态，仍使用 `TINYINT`，并在 COMMENT 中列出完整枚举含义）。
- **主键**：
  - `id` 必须为 `BIGINT NOT NULL COMMENT '主键ID（雪花算法）'`。
  - 主键必须 `PRIMARY KEY (id)`。
  - 禁止使用 `AUTO_INCREMENT`（统一由应用侧生成雪花 ID）。
- **列顺序**：所有业务表字段顺序必须为：业务字段 → `status` → `is_deleted` → `create_time` → `last_modified_time`。
- **注释**：
  - 每张表必须有 `COMMENT='xxx'`。
  - 每一列必须有 `COMMENT 'xxx'`，注释必须是可读中文，且不允许空注释。
- **字段命名**：
  - 表名与字段名必须使用 snake_case。
  - 外键引用字段必须命名为 `{ref}_id`（如 `user_id`、`order_id`），禁止 `uid`、`orderid`。
- **禁止项**：
  - 禁止 `SELECT *`（此条为 SQL 编写规范，同样要求 AI 遵守）。
  - 禁止在业务表中使用物理外键约束（FK），只允许通过索引保障性能。

## 二、命名规范（固定格式）

- **表名格式**（唯一格式）：
  - 必须使用：`{{TABLE_PREFIX}}{entity}`
  - `{entity}` 必须为 snake_case 名词短语；如需按领域区分，将领域作为 `{entity}` 的前缀（例如 `trade_order`、`product_sku`）。
- **索引命名**：
  - 普通索引：`idx_{col}` 或 `idx_{col1}_{col2}`
  - 唯一索引：`uk_{col}` 或 `uk_{col1}_{col2}`
  - 所有索引名必须唯一且可读，禁止 `index1`、`idx_1`。

## 三、字段类型规范（固定映射）

- **金额/单价/成本**：`DECIMAL(10,4) NOT NULL DEFAULT 0.0000 COMMENT 'xxx（单位：元）'`
- **数量/次数**：`INT NOT NULL DEFAULT 0 COMMENT 'xxx'`
- **布尔**：`TINYINT NOT NULL DEFAULT 0 COMMENT '是否xxx：0否；1是'`
- **手机号**：`VARCHAR(32) DEFAULT NULL COMMENT '手机号'`（允许国际区号）
- **邮箱**：`VARCHAR(128) DEFAULT NULL COMMENT '邮箱'`
- **名称**：`VARCHAR(128) NOT NULL COMMENT '名称'`
- **编码/业务单号**：`VARCHAR(64) NOT NULL COMMENT '业务编码'`（如需唯一必须加唯一索引）
- **备注**：`VARCHAR(512) DEFAULT NULL COMMENT '备注'`
- **长文本**：`TEXT COMMENT 'xxx'`
- **JSON**：`JSON COMMENT 'xxx'`（如需要基于 JSON 字段查询，必须冗余为普通列并建索引，禁止直接对 JSON 路径做高频查询）

## 四、通用字段（强制统一）

- 每张业务表必须包含并按固定定义创建以下字段：
  - `status`：`TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1正常；0禁用'`
  - `is_deleted`：`TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0未删；1已删'`
  - `create_time`：`DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'`
  - `last_modified_time`：`DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'`

## 五、热门索引（强制最小集 + 规则化追加）

### 5.1 强制最小索引集（每张业务表必须具备）

- `PRIMARY KEY (id)`
- `KEY idx_is_deleted_id (is_deleted, id)`：软删除过滤 + 游标分页（最通用）
- `KEY idx_status_id (status, id)`：状态过滤 + 游标分页（最通用）
- `KEY idx_create_time_id (create_time, id)`：按时间范围查询 + 稳定排序

### 5.2 规则化追加索引（出现字段就必须创建）

- 任何 `{ref}_id` 字段必须创建单列索引：`KEY idx_{ref}_id ({ref}_id)`
  - 例：`user_id` → `idx_user_id (user_id)`
- 任何业务唯一键字段必须创建唯一索引：
  - 例：`phone` → `UNIQUE KEY uk_phone (phone)`
  - 例：`order_no` → `UNIQUE KEY uk_order_no (order_no)`
- 列表查询索引禁止“凭经验”手写，必须通过“查询模式表格”（7.4）按 5.3 算法生成。

### 5.3 索引生成算法（AI 必须严格执行，不允许“凭感觉”）

- AI 在生成建表 SQL 前，必须先输出“查询模式表格”（见 7.4）。
- AI 必须按以下规则推导索引（并写入“索引定义表格”与最终 DDL）：
  1. **主键**：固定为 `PRIMARY KEY (id)`。
  2. **最小索引集**：固定创建 `idx_is_deleted_id`、`idx_status_id`、`idx_create_time_id`。
  3. **唯一键**：对“唯一键集合”中每个集合 `{c1, c2, ...}`，创建 `UNIQUE KEY uk_c1_c2... (c1, c2, ...)`。
  4. **引用键**：对每个 `{ref}_id`，创建 `KEY idx_{ref}_id ({ref}_id)`。
  5. **列表查询**：对每个列表查询模式：
     - 等值过滤列（按给定顺序）记为 `E=[e1,e2,...]`（不含 `is_deleted` 时必须补齐为第一列）。
     - 范围过滤列（0 或 1 个）记为 `R`（通常是 `create_time`）。
     - 排序字段固定为 `id`（游标分页）。
     - 索引列顺序固定为：`is_deleted` → `E（去重）` → `R（如有）` → `id`。
     - 索引命名固定为：`idx_{E...}_{R?}_id`（例如 `idx_user_id_status_create_time_id`）。
  6. **去重规则**：若推导出的索引列序与已存在索引完全一致，则禁止重复创建。

## 六、中间表（多对多）标准模板（强制）

- 表名：`{{TABLE_PREFIX}}rel_{a}_{b}`（a、b 需使用业务实体名的小写 snake_case）
- 必须字段：`id`、`a_id`、`b_id`、`is_deleted`、`create_time`、`last_modified_time`
- 必须索引：
  - `UNIQUE KEY uk_a_id_b_id (a_id, b_id)`
  - `KEY idx_a_id (a_id)`
  - `KEY idx_b_id (b_id)`
  - 仍需包含最小索引集中的 `idx_is_deleted_id`、`idx_create_time_id`（如字段已满足可复用）

## 七、AI 生成建表输入模板（必须先填表，再输出 SQL）

### 7.1 表定义表格（必须提供）

| 项目 | 值 |
|------|----|
| 表名 | `{{TABLE_PREFIX}}xxx` |
| 表注释 | `xxx` |
| 主键 | `id`（雪花） |

### 7.2 字段定义表格（必须提供）

| 字段名 | 类型 | NOT NULL | 默认值 | 注释 |
|--------|------|----------|--------|------|
| id | BIGINT | 是 | - | 主键ID（雪花算法） |
| ... | ... | ... | ... | ... |
| status | TINYINT | 是 | 1 | 状态：1正常；0禁用 |
| is_deleted | TINYINT | 是 | 0 | 逻辑删除：0未删；1已删 |
| create_time | DATETIME | 是 | CURRENT_TIMESTAMP | 创建时间 |
| last_modified_time | DATETIME | 是 | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 7.3 索引定义表格（必须提供）

| 索引名 | 类型 | 列（按顺序） | 说明 |
|--------|------|--------------|------|
| PRIMARY | PRIMARY | id | 主键 |
| idx_is_deleted_id | INDEX | is_deleted, id | 软删过滤 + 游标分页 |
| idx_status_id | INDEX | status, id | 状态过滤 + 游标分页 |
| idx_create_time_id | INDEX | create_time, id | 时间范围查询 |
| ... | ... | ... | ... |

### 7.4 查询模式表格（必须提供，用于生成“热门索引”）

| 查询名称 | 等值过滤列（按顺序） | 范围过滤列（最多1个） | 排序 | 用途 |
|---------|------------------------|------------------------|------|------|
| list_default | status | create_time | id DESC | 默认列表页（状态+时间范围） |
| ... | ... | ... | ... | ... |

## 八、建表 SQL 输出模板（AI 生成必须按此格式）

```sql
CREATE TABLE `{{TABLE_PREFIX}}xxx` (
  `id` BIGINT NOT NULL COMMENT '主键ID（雪花算法）',
  ...
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1正常；0禁用',
  `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0未删；1已删',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `last_modified_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_is_deleted_id` (`is_deleted`, `id`),
  KEY `idx_status_id` (`status`, `id`),
  KEY `idx_create_time_id` (`create_time`, `id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='xxx';
```
