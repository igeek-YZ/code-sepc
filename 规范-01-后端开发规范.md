# 后端开发规范

## 一、 技术栈要求 (后端)
- 后端框架：Spring Boot + mybatis-plus + jwt + feign
- 数据库：MySQL 5.7+
- 缓存：Redis 6.0+
- 验证码服务：邮件验证码服务, 短信验证码服务
- API 接口：RESTful API

## 二、 架构设计规范

### 1. 分层架构
项目采用模块化分层架构，明确各模块职责，禁止循环依赖。

### 2. 模块划分与职责
| 模块名 | 职责 | 路径示例 |
|--------|------|----------|
| **common-module** | 全局常量、工具类、异常处理、统一响应对象、AOP 切面。 | `common-module/src/main/java/{{PACKAGE_BASE}}/common` |
| **dal-module** | 数据库实体 (Entity)、Mapper 接口、XML、DAL Service。仅暴露 DAL Service。 | `dal-module/src/main/java/{{PACKAGE_BASE}}/dal` |
| **third-party-module** | 集成外部服务 (短信、支付等)，隐藏具体供应商实现。 | `third-party-module/src/main/java/{{PACKAGE_BASE}}/thirdparty` |
| **admin-xxx-module** | B端业务模块，面向管理员，接口路径前缀 `/admin/`。 | `admin-account-module/...` |
| **frontend-xxx-module** | C端业务模块，面向消费者，接口路径前缀 `/api/`。 | `frontend-user-module/...` |
| **hub-module** | 统一三方回调入口，使用适配器模式处理不同平台数据。 | `hub-module/...` |
| **task-module** | 定时任务、MQ 消费者、异步任务。 | `task-module/...` |

### 3. Hub 回调模块设计
- **接口路径**：`/hub/{eventType}/{platform}/{tenantId}`
- **核心适配器代码**：
```java
public interface HubAdapter {
    String eventType();
    String platform();
    HubCallbackData parse(String tenantId, String eventType, String platform, Map<String, String> queryParams, String rawData);
    Object buildCallbackData(String tenantId, String eventType, String platform, HubCallbackData data);
}

@Data
@Builder
public class HubCallbackData implements Serializable {
    private String tenantId;
    private String eventType;
    private String platform;
    private Map<String, Object> data;
    private boolean success;
    private String errorMsg;
}
```

## 三、 命名与编码规范

### 1. 命名规范对照表
| 类型 | 命名规则 | 正例 |
|------|----------|------|
| Entity | `XxxEntity` | `UserEntity` |
| DTO 请求 | `XxxReq` | `UserCreateReq` |
| DTO 响应 | `XxxResp` / `XxxVO` | `UserInfoVO` |
| Mapper | `XxxMapper` | `UserMapper` |
| Service 接口 | `XxxService` | `UserService` |
| Service 实现 | `XxxServiceImpl` | `UserServiceImpl` |
| Controller | `XxxController` | `UserController` |

### 2. 方法命名规则
- 查询单条：`getXxxByXxx`
- 查询列表：`listXxx`
- 分页查询：`pageXxx`
- 新增：`createXxx`
- 修改：`updateXxx`
- 删除：`deleteXxxByXxx`

### 3. 错误码规范
格式：`{模块码(2位)}{类型码(2位)}{序号(1位)}`
- `00`: 公共模块 (00001 参数校验失败)
- `10`: 用户模块
- `20`: 商品模块
- `30`: 订单模块
- `60`: 认证模块 (60010 Token无效)

## 四、 核心设计要求

### 1. Redis Key 规范
格式：`{业务前缀}:{模块名}:{具体标识}`
- 必须定义在常量类中，严禁硬编码。
- 必须设置合理的过期时间。

### 2. 事务与并发控制
- **事务**：使用 `@Transactional(rollbackFor = Exception.class)`。
- **并发**：涉及资金、库存扣减必须使用 **Redisson** 分布式锁。
- **锁粒度**：必须包含业务唯一标识，如 `lock:order:pay:{orderId}`。

### 3. 幂等性控制
- 支付、下单、状态流转必须实现幂等。
- 方案：Redis 唯一键 (`idempotent:{biz}:{id}`) 或 数据库状态机条件更新。

## 五、 代码模板 (AI 生成基准)

### 1. 统一响应对象 (`Result<T>`)
```java
@Data
public class Result<T> implements Serializable {
    private String code;
    private String msg;
    private T data;
    public static <T> Result<T> success(T data) { ... }
    public static <T> Result<T> error(String code, String msg) { ... }
}
```

### 2. 基础实体 (`BaseEntity`)
```java
@Data
public abstract class BaseEntity implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long id;
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime lastModifiedTime;
    @TableLogic
    private Integer isDeleted;
}
```

### 3. Feign 日志模板 (CURL 格式)
必须在 `FeignLogger` 中实现多行 `curl` 打印：
```bash
curl -X POST 'https://api.example.com/v1/users' \
  -H 'Content-Type: application/json' \
  -d '{"name": "test"}'
```

## 六、 详细目录结构示例
```text
project-root
├── common-module
│   └── src/main/java/{{PACKAGE_BASE}}/common
│       ├── config/constant/exception/model/utils
├── dal-module
│   └── src/main/java/{{PACKAGE_BASE}}/dal
│       ├── entity/mapper/service (DAL Service)
├── biz-modules
│   ├── admin-xxx-module (B端)
│   │   └── controller/admin/service/model
│   └── frontend-xxx-module (C端)
│       └── controller/api/service/model
├── hub-module
│   └── src/main/java/{{PACKAGE_BASE}}/hub
│       ├── controller/adapter/model/event
└── task-module
    └── src/main/java/{{PACKAGE_BASE}}/task
        └── order/inventory/marketing (按领域划分)
```
